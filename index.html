<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>m3_test</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>


    <style>
      body {
        margin: 0;
        padding: 0;
      }
            
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      .panel {
        position: fixed;
        top: 5px;
        left: 10px;   
        display: flex;
        flex-direction: column;    
        width: 200px;
        max-height: 100%;
        padding: 10px;
        z-index: 2;
        flex: 0 0 auto;    
        border-radius: 10px;
        margin: 7px;    
        font-family: Arial, Helvetica, sans-serif;
        font-weight: normal;  
        font-size: 14px;    
        background-color: #fff;    
        box-shadow: 0 10px 20px -10px rgba(0, 0, 0, 0.5);
       }
      
    button {
        background: #fff;
        display: flex;
        border-color: white;
        margin: -5px;
        
    }

    button a {
        width: 100%;
        font-size: 14px;
        color: #404040;
        display: block;
        margin: 5px -2px 5px -2px;
        padding: 6px;
        text-decoration: none;
        border-radius: 3px;
        text-align: left;
    }

    a:hover{
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 3px;
    }

    a.active{
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 3px;
    }

    

 

    .row{
        display: flex;
        margin-top: 5px;
        flex-direction: row;
        padding: 5px;
        justify-content: space-between;
    }

   .button{
    margin-bottom: 10px;
    text-align: left;
    font-size: 14px;
    color: rgba(0, 0, 0, 0.4);
    background-color: transparent;
    padding: 3px 6px 6px;
    
    border-style: none;
    
    
    transition: all 0.4s ease 0s;
    }

    .button:active{
        color: #000000;
    }

    .button:focus {
    outline: none;
    }

    input[type=range]{ 
        width: 90%;
    height: 30px;
  padding: 5px;
  margin: 5px;
  background: transparent;
  -webkit-appearance: none;
  -moz-appearance: none;
  }
/* Focus styles */
  input[type=range]:focus {
    outline: none;
  }
  input[type=range]::-moz-focus-outer {
    border: 0;
  }
/* Track styles */
  input[type=range]::-webkit-slider-runnable-track {
    height: 2px;
    border: none;
    border-radius: 1px;
    background-color: black;
    top: 3px;
  }
  input[type=range]::-moz-range-track {
    height: 2px;
    border: none;
    border-radius: 1px;
    background-color: black;
    top: 3px;
  }
  input[type=range]::-ms-track {
    top: 3px;
    height: 2px;
    border: none;
    border-radius: 1px;
    background-color: black;
  }
  
/* Thumb styles */
  
  
  input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  border: 1.25px solid #000000;
  height: 25px;
  width: 25px;
  border-radius: 50%;
  background: #ffffff;
  cursor: pointer;
  margin-top: -13px; /* You need to specify a margin in Chrome, but in Firefox and IE it is automatic */
   /* Add cool effects to your sliders! */
}

/* All the same stuff for Firefox */
input[type=range]::-moz-range-thumb {
  
  border: 1.25px solid #000000;
  height: 25px;
  width: 25px;
  border-radius: 50%;
  background: #ffffff;
  cursor: pointer;
}

/* All the same stuff for IE */
input[type=range]::-ms-thumb {
  
  border: 1.25px solid #000000;
  height: 25px;
  width: 25px;
  border-radius: 50%;
  background: #ffffff;
  cursor: pointer;
}

ul{
    display: flex;
    flex-direction: row;
    
    align-items: center;
    justify-content: space-around;
    
}

li{
    display: flex;
    flex-grow: 1;
    margin: auto;
    padding: 0px 15px 0px 15px;
    color: rgb(0, 0, 0);
    background-color: transparent;

}




            
    </style>     
</head>
<body>
    

   
<div id='map'></div>
<div class=panel>
   
    
    
    <div class='row' id='filters'>
        <input class='button' id='morning' type='radio' name='toggle' value='morning' checked='checked'>Утро</input>
         
        <input class='button' id='day' type='radio' name='toggle' value='day'>День</input>
         
        <input class='button' id='evening' type='radio' name='toggle' value='evening'>Вечер</input>
    </div>
    <div  id='sliderbar'>
        
        <input id='slider' class='row' type='range' min='15' max='45' step='15' value='15' />
        <ul>
            <li>15мин</li>
            <li>30мин</li>
            <li>45мин</li> 
        <ul>
    </div> 
  
    <button id="menu"></button> 
<div>
<script>

mapboxgl.accessToken = 'pk.eyJ1IjoibW9zY293Y2l0eW1hcCIsImEiOiJjajc3ZnQ1aGUxem41MzNudXU3MnBnZDA2In0.akDBtVzE-R3FgVs64ObGLg';
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/moscowcitymap/cjiomhg5w29ta2sq80fv48hs2',
    center: [37.623140, 55.755509],
    minZoom: 9,
    maxZoom:18,
    zoom: 9.5
});

const points ={
  "type": "FeatureCollection",
  "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
  "features": [
  { "type": "Feature", "properties": { "id": 1, "longitude": 37.47751, "latitude": 55.68583, "point_id": 1 }, "geometry": { "type": "Point",   "coordinates": [ 37.477512496004607, 55.685832401822807 ] } },
  { "type": "Feature", "properties": { "id": 2, "longitude": 37.5322, "latitude": 55.67862, "point_id": 2 }, "geometry": { "type": "Point",   "coordinates": [ 37.532204229564648, 55.678622407845666 ] } },
  { "type": "Feature", "properties": { "id": 5, "longitude": 37.48132, "latitude": 55.64885, "point_id": 5 }, "geometry": { "type": "Point",   "coordinates": [ 37.48132187048143, 55.648847939103604 ] } },
  { "type": "Feature", "properties": { "id": 6, "longitude": 37.61655, "latitude": 55.6731, "point_id": 6 }, "geometry": { "type": "Point",   "coordinates": [ 37.61655466440849, 55.673098960290638 ] } }
  ]
};


 



map.on( 'load', () => {
    var filterSrez = ['==', ['number', ['get', 'srez']], 15];
    var filterDay = ['!=', ['string', ['get', 'day_time']], 'placeholder'];

    map.addSource('isochrones', {
            'type': 'geojson',
            'data': 'https://raw.githubusercontent.com/lena-emaya/m3routes/master/iso_4_merge.geojson'
    });
    map.addSource('points', {
            'type': 'geojson',
            'data': points
    });

    map.addSource('routes', {
        'type': 'geojson',
        'data': 'https://raw.githubusercontent.com/lena-emaya/m3routes/master/int.geojson'
    });

    


    map.addLayer({
        'id': 'isochrones',
        'type': 'fill',
        'source': 'isochrones',
        
        'paint': {
            'fill-color': '#088',
            'fill-opacity': 0
        }
    });

    map.addLayer({
        'id': 'isochrones-highlighted',
        'type': 'fill',
        'source': 'isochrones',
        'filter': ['all', filterSrez, filterDay],
        'paint': {
            'fill-color':  [
               "case",
               [
                 "==",
                 ["get", "state"],
                 "current"
               ],
               "#50E7FF",
               [
                 "==",
                 ["get", "state"],
                 "plan"
               ],
               "hsla(216, 81%, 54%, 0.3)",
               "#000000"
            ],
            'fill-opacity': 0.25
        }
    });

    map.addLayer({
        'id': 'isochrones-highlighted2',
        'type': 'line',
        'source': 'isochrones',
        'filter': ['all', filterSrez, filterDay],
        'paint': {
            'line-color': [
               "case",
               [
                 "==",
                 ["get", "state"],
                 "current"
               ],
               "#36BCE3",
               [
                 "==",
                 ["get", "state"],
                 "plan"
               ],
               "hsl(216, 81%, 54%)",
               "#000000"
            ],
            "line-dasharray": [
               "step",
               ["zoom"],
               ["literal", [1, 1]],
               22,
               ["literal", [2, 1]]
            ],
            "line-width": [
              "interpolate",
              ["exponential", 1.3],
              ["zoom"],
              9,
              1,
              22,
              5
            ] 
        }
    });


    document.getElementById('slider').addEventListener('input', function(e) {
        var srez = parseInt(e.target.value);
        
        filterSrez = ['==', ['number', ['get', 'srez']], srez];
        map.setFilter('isochrones-highlighted', ['all', filterSrez, filterDay]);
        map.setFilter('isochrones-highlighted2', ['all', filterSrez, filterDay]);
 
    //    document.getElementById('srezs').innerText = srez;
    });

    document.getElementById('filters').addEventListener('change', function(e) {
        var day = e.target.value;
        if (day === 'morning') {
    
        filterDay = ['!=', ['string', ['get', 'day_time']], 'morning'];
        }
  
        map.setFilter('isochrones-highlighted', ['all', filterSrez, filterDay]);
        map.setFilter('isochrones-highlighted2', ['all', filterSrez, filterDay]);
    });


    
    map.addLayer({
        "id": "Маршруты",
        "type": "line",
        "source": "routes",
        "paint": {
            "line-color": [
                "step",
                ["get", "percieved_interval"],
                "#FC4D1E",
                11,
                "#FECE50",
                21,
                "#3EDCF0",
                30,
                "#2DE162"
            ],
            "line-width": [
              "interpolate",
              ["exponential", 1.21],
              ["zoom"],
              9,
              [
                "case",
                [
                  "<",
                  [
                    "number",
                    ["get", "percieved_interval"]
                  ],
                  10
                ],
                2.4,
                [
                  "<",
                  [
                    "number",
                    ["get", "percieved_interval"]
                  ],
                  20
                ],
                1.65,
                [
                  ">=",
                  [
                    "number",
                    ["get", "percieved_interval"]
                  ],
                  30
                ],
                1.2,
                [
                  ">=",
                  [
                    "number",
                    ["get", "percieved_interval"]
                  ],
                  30
                ],
                1,
                1
              ],
              22,
              [
                "case",
                [
                  "<",
                  [
                    "number",
                    ["get", "percieved_interval"]
                  ],
                  10
                ],
                30,
                [
                  "<",
                  [
                    "number",
                    ["get", "percieved_interval"]
                  ],
                  20
                ],
                20,
                [
                  "<",
                  [
                    "number",
                    ["get", "percieved_interval"]
                  ],
                  30
                ],
                15,
                [
                  ">=",
                  [
                    "number",
                    ["get", "percieved_interval"]
                  ],
                  30
                ],
                10,
                1
              ]
            ]
        },
        "layout": {
            "visibility": "none"
        }
    });



    map.addLayer({
        "id": "point",
        "type": "circle",
        "source": "points",
        "paint": {
            "circle-radius": 4,
            "circle-color": "#7482FF",
            "circle-stroke-color": "#fff",
            "circle-stroke-width": 1
        }
    });

    
    



   
});

var toggleableLayerIds = [ "Маршруты" ];

for (var i = 0; i < toggleableLayerIds.length; i++) {
    var id = toggleableLayerIds[i];

    var link = document.createElement('a');
    link.href = '#';
    link.className = 'active';
    link.textContent = id;

    link.onclick = function (e) {
        var clickedLayer = this.textContent;
        e.preventDefault();
        e.stopPropagation();

        var visibility = map.getLayoutProperty(clickedLayer, 'visibility');

        if (visibility === 'visible') {
            map.setLayoutProperty(clickedLayer, 'visibility', 'none');
            this.className = '';
        } else {
            this.className = 'active';
            map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
        }
    };

    var layers = document.getElementById('menu');
    layers.appendChild(link);
}






</script>

</body>
</html>
